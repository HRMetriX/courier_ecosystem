name: Alert System

on:
  # 1. –°–ª—É—à–∞–µ–º –∑–∞–ø—É—Å–∫–∏ parse –∏ publish workflow
  workflow_run:
    workflows: 
      - "Parse HH vacancies"    # –ó–ê–ú–ï–ù–ò –ù–ê –¢–û–ß–ù–û–ï –ò–ú–Ø –¢–í–û–ï–ì–û PARSE WORKFLOW
      - "Publish vacancies"     # –ó–ê–ú–ï–ù–ò –ù–ê –¢–û–ß–ù–û–ï –ò–ú–Ø –¢–í–û–ï–ì–û PUBLISH WORKFLOW
    types: 
      - requested    # –ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
      - completed    # –ö–æ–≥–¥–∞ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è

  # 2. –†—É—á–Ω–æ–π —Ç–µ—Å—Ç
  workflow_dispatch:
    inputs:
      message:
        description: '–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'
        required: false
        default: '–¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã –∞–ª–µ—Ä—Ç–æ–≤'
        type: string

jobs:
  handle-alerts:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install requests
        run: pip install requests
      
      - name: Send alert
        env:
          TG_ALERT_BOT_TOKEN: ${{ secrets.TG_ALERT_BOT_TOKEN }}
          TG_ALERT_CHAT_ID: ${{ secrets.TG_ALERT_CHAT_ID }}
        run: |
          # –î–ª—è workflow_run —Å–æ–±—ã—Ç–∏–π
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            WORKFLOW_NAME="${{ github.event.workflow.name }}"
            STATUS="${{ github.event.workflow_run.status }}"
            CONCLUSION="${{ github.event.workflow_run.conclusion }}"
            
            python -c "
import os, sys, json
sys.path.append('scripts')
from alert_sender import send_alert

workflow_name = '''$WORKFLOW_NAME'''
status = '''$STATUS'''
conclusion = '''$CONCLUSION'''

if 'parse' in workflow_name.lower():
    ctx = 'parser'
    emoji = 'üîç'
elif 'publish' in workflow_name.lower():
    ctx = 'publisher'
    emoji = 'üì¢'
else:
    ctx = 'system'
    emoji = '‚öôÔ∏è'

if status == 'requested':
    send_alert(f'{emoji} {workflow_name} –∑–∞–ø—É—â–µ–Ω', 
               alert_type='start', 
               context=ctx)
elif status == 'completed':
    if conclusion == 'success':
        send_alert(f'{emoji} {workflow_name} —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω',
                   alert_type='success',
                   context=ctx)
    else:
        send_alert(f'{emoji} {workflow_name} –∑–∞–≤–µ—Ä—à–µ–Ω —Å –æ—à–∏–±–∫–æ–π',
                   details=f'–°—Ç–∞—Ç—É—Å: {conclusion}',
                   alert_type='error',
                   context=ctx)
            "
          
          # –î–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            MESSAGE="${{ github.event.inputs.message }}"
            
            python -c "
import os, sys
sys.path.append('scripts')
from alert_sender import send_alert
send_alert('''$MESSAGE''', 
           details='–†—É—á–Ω–æ–π —Ç–µ—Å—Ç –∏–∑ GitHub Actions',
           alert_type='info',
           context='system')
            "
          fi
